{% extends "base.html" %}
{% block title %}Modify Intents{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modify_intents.css') }}">
{% endblock %}

{% block content %}

<div class="header">
    <h1 class="mt-4">Modify Intents</h1>
    <button class="add_new_button" onclick="window.location.href='{{ url_for('add_intent') }}'">Add New Intent</button>
    <button class="train_model" onclick="window.location.href='{{ url_for('api_routes.train_model') }}'">Train Model</button>
    <button class="test_model" id="testModelButton">Test Model</button></div>

<div class="intents_div">
   <table>
        <thead>
            <tr>
                <th>Intent Tag</th>
                <th>Edit</th>
                <th>Delete</th>
                <th>Last Modified Date</th>
                <th>Last Modified By</th>
            </tr>
        </thead>
        <tbody>
            {% for intent in intents %}
                <tr>
                    <td>{{ intent['tag'] }}</td>
                    <td><a href="{{ url_for('edit_intents', tag=intent['tag']) }}">Edit</a></td>
                    <td><a href="{{ url_for('delete_intents', tag=intent['tag']) }}" class="delete-intent" data-tag="{{ intent['tag'] }}">Delete</a></td>
                    <td>{{ intent.get('last_modified_date', 'N/A') }}</td>
                    <td>{{ intent.get('last_modified_by', 'N/A') }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h2>Confirm Deletion</h2>
        <p>Are you sure you want to delete this intent?</p>
        <!-- Form for deletion -->
        <form id="deleteForm" method="POST" action="">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit" id="confirmDelete">Yes, delete it</button>
        </form>
        <button id="cancelDelete">No, cancel</button>
    </div>
</div>

<script>
    document.querySelectorAll('.delete-intent').forEach(function(deleteLink) {
        deleteLink.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default link behavior
            const tag = deleteLink.getAttribute('data-tag'); // Get the tag for deletion
            showModal(tag);
        });
    });

    function showModal(tag) {
        const modal = document.getElementById('deleteModal');
        modal.style.display = 'flex'; // Show the modal

        // Handle confirm delete: update the form action dynamically
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.action = "/delete_intents/" + tag; // Set the form action dynamically

        // Handle cancel delete
        document.getElementById('cancelDelete').onclick = function() {
            modal.style.display = 'none'; // Hide the modal
        };
    }

    // Optional: Close the modal when clicking outside the modal content
    window.onclick = function(event) {
        const modal = document.getElementById('deleteModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
</script>
<!-- Test Model Modal -->
<div id="testModal" class="modal">
    <div class="modal-content">
        <h2>Test Model</h2>
        <p>Enter a message to test the model:</p>
        <form id="testForm" method="POST">
            <input type="text" name="message" id="message" placeholder="Enter a message" required>
            <button type="submit" id="testModel">Test</button>
        </form>
        <button id="cancelTest">Cancel</button>

        <!-- Result Display -->
        <div id="testResult" style="display: none; margin-top: 20px;">
            <h3>Test Result:</h3>
            <p><strong>Response:</strong> <span id="modelResponse"></span></p>
            <p><strong>Confidence:</strong> <span id="confidenceScore"></span></p>
            <p><strong>Intent:</strong> <span id="intentTag"></span></p>
        </div>
    </div>
</div>

<script>
    // Show the Test Model modal when the button is clicked
    document.querySelector('.test_model').addEventListener('click', function(event) {
        event.preventDefault();
        const modal = document.getElementById('testModal');
        modal.style.display = 'flex';
    });

    // Close the modal when cancel is clicked
    document.getElementById('cancelTest').onclick = function() {
        const modal = document.getElementById('testModal');
        modal.style.display = 'none';
        resetModal(); // Reset the modal for new test
    };

    // Handle the test model form submission with AJAX
    document.getElementById('testForm').onsubmit = async function(event) {
        event.preventDefault();

        const message = document.getElementById('message').value;
        const response = await fetch("{{ url_for('api_routes.test_model') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'message': message
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Populate the result fields with the model's response
            document.getElementById('modelResponse').textContent = data.response;
            document.getElementById('confidenceScore').textContent = data.confidence;
            document.getElementById('intentTag').textContent = data.intent;

            // Show the result div
            document.getElementById('testResult').style.display = 'block';
        } else {
            document.getElementById('modelResponse').textContent = 'Error: ' + data.error;
            document.getElementById('confidenceScore').textContent = '-';
            document.getElementById('intentTag').textContent = '-';

            document.getElementById('testResult').style.display = 'block';
        }
    };

    // Reset modal form and hide result section
    function resetModal() {
        document.getElementById('message').value = ''; // Clear input
        document.getElementById('testResult').style.display = 'none'; // Hide results
    }
</script>
{% endblock %}